# Конфигурация для staging окружения с минимальными ресурсами
# Для кластеров с ограниченными ресурсами
environment: staging
replicaCount: 1  # Уменьшено до 1 для экономии ресурсов

# Секреты для доступа к Harbor registry
# Создайте secret командой:
# kubectl create secret docker-registry harbor-registry \
#   --docker-server=harbor.openidealab.com \
#   --docker-username=your-username \
#   --docker-password=your-password \
#   -n codelab
imagePullSecrets:
  - name: harbor-registry

# Образы из Harbor registry
images:
  authService:
    repository: harbor.openidealab.com/codelab/auth-service
    tag: latest
  gateway:
    repository: harbor.openidealab.com/codelab/gateway
    tag: latest
  agentRuntime:
    repository: harbor.openidealab.com/codelab/agent-runtime
    tag: latest
  llmProxy:
    repository: harbor.openidealab.com/codelab/llm-proxy
    tag: latest

# Настройки Ingress
ingress:
  enabled: true
  className: nginx
  host: codelab.openidealab.com
  tls: true
  tlsSecretName: codelab-stage-tls
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-staging"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/websocket-services: "gateway"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  paths:
    # OAuth endpoints для auth-service
    oauth:
      path: /oauth
      pathType: Prefix
      service: auth-service
      port: 8003
    # Well-known endpoints для auth-service
    wellknown:
      path: /.well-known
      pathType: Prefix
      service: auth-service
      port: 8003
    # API endpoints для gateway
    api:
      path: /api/v1
      pathType: Prefix
      service: gateway
      port: 8000
    # Gateway доступен по корневому пути /
    gateway:
      path: /
      pathType: Prefix
      service: gateway
      port: 8000

# Используем внутренний PostgreSQL для staging
services:
  authService:
    database:
      type: postgres
      useInternal: true
      host: postgres
      port: 5432
      name: auth_db
      user: codelab
      password: "staging-password-change-me"
    secrets:
      AUTH_SERVICE__MASTER_KEY: "staging-master-key-change-me"
    persistence:
      data:
        enabled: true
        size: 1Gi
        storageClass: ""
      keys:
        enabled: true
        size: 100Mi
        storageClass: ""
  
  agentRuntime:
    database:
      type: postgres
      useInternal: true
      host: postgres
      port: 5432
      name: agent_runtime
      user: codelab
      password: "staging-password-change-me"
    secrets:
      AGENT_RUNTIME__INTERNAL_API_KEY: "staging-api-key-change-me"
    persistence:
      data:
        enabled: true
        size: 5Gi
        storageClass: ""
  
  gateway:
    env:
      GATEWAY__LOG_LEVEL: "INFO"
      GATEWAY__USE_JWT_AUTH: "true"
    secrets:
      GATEWAY__INTERNAL_API_KEY: "staging-api-key-change-me"
  
  llmProxy:
    env:
      LLM_PROXY__LOG_LEVEL: "INFO"
    secrets:
      LLM_PROXY__INTERNAL_API_KEY: "staging-api-key-change-me"
      LLM_PROXY__LITELLM_PROXY_URL: "http://litellm-proxy-staging:4000"
      LLM_PROXY__LITELLM_API_KEY: "staging-litellm-key"
  
  postgres:
    enabled: true
    persistence:
      enabled: true
      size: 10Gi
      storageClass: ""
    secrets:
      POSTGRES_PASSWORD: "staging-password-change-me"
  
  redis:
    enabled: true

# Минимальные ресурсы для кластеров с ограничениями
resources:
  authService:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  gateway:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  agentRuntime:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi
  
  llmProxy:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  redis:
    requests:
      cpu: 25m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
  
  postgres:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

# Security context
securityContext:
  enabled: true
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
